{% extends "base.html" %}

{% block title %}Token Hosszabbítási Kérelmek - ZedinArkManager{% endblock %}

{% block content %}
<div class="page">
    <div class="page-header">
        <h2><i class="fas fa-clock"></i> Token Hosszabbítási Kérelmek</h2>
        <p>Manager Admin - pending kérelmek kezelése</p>
    </div>
    
    {% if request.query_params.get("success") %}
        <div class="alert alert-success">{{ request.query_params.get("success") }}</div>
    {% endif %}
    
    <div class="card">
        <div class="card-body">
            {% if extension_requests %}
                <table class="table">
                    <thead>
                        <tr>
                            <th>Felhasználó</th>
                            <th>Token</th>
                            <th>Jelenlegi lejárat</th>
                            <th>Kért napok</th>
                            <th>Új lejárat</th>
                            <th>Kérés dátuma</th>
                            <th>Megjegyzés</th>
                            <th>Műveletek</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for req in extension_requests %}
                            <tr>
                                <td>
                                    {% if req.user %}
                                        {{ req.user.username }}<br>
                                        <small class="text-muted">{{ req.user.email }}</small>
                                    {% else %}
                                        <span class="text-muted">Nincs</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if req.token %}
                                        <code>{{ req.token.token[:20] }}...</code>
                                    {% else %}
                                        <span class="text-muted">Nincs</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if req.token and req.token.expires_at %}
                                        {{ req.token.expires_at.strftime("%Y-%m-%d %H:%M") }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td><strong>{{ req.requested_days }} nap</strong></td>
                                <td>
                                    {% if req.new_expiry %}
                                        {{ req.new_expiry.strftime("%Y-%m-%d %H:%M") }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ req.created_at.strftime("%Y-%m-%d %H:%M") if req.created_at else "-" }}</td>
                                <td>
                                    {% if req.notes %}
                                        <small>{{ req.notes[:50] }}{% if req.notes|length > 50 %}...{% endif %}</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <form method="POST" action="/tokens/extension-requests/{{ req.id }}/approve" style="display: inline;">
                                            <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('Biztosan jóváhagyod ezt a kérelmet?');">
                                                <i class="fas fa-check"></i> Jóváhagyás
                                            </button>
                                        </form>
                                        <button class="btn btn-danger btn-sm" onclick="showRejectModal({{ req.id }})">
                                            <i class="fas fa-times"></i> Elutasítás
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Nincsenek pending hosszabbítási kérelmek.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Elutasítás Modal -->
<div id="rejectModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 10px; width: 500px; max-width: 90%;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3><i class="fas fa-times"></i> Kérés Elutasítása</h3>
            <button onclick="closeRejectModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <form method="POST" action="" id="rejectForm">
            <div style="margin-bottom: 15px;">
                <label for="rejectNotes" style="display: block; margin-bottom: 5px; font-weight: bold;">Megjegyzés (opcionális):</label>
                <textarea id="rejectNotes" name="notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeRejectModal()" class="btn btn-secondary" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Mégse</button>
                <button type="submit" class="btn btn-danger" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-times"></i> Elutasítás
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showRejectModal(requestId) {
    document.getElementById('rejectForm').action = `/tokens/extension-requests/${requestId}/reject`;
    document.getElementById('rejectModal').style.display = 'block';
}

function closeRejectModal() {
    document.getElementById('rejectModal').style.display = 'none';
}

// Modal bezárása kattintásra a háttérre
window.onclick = function(event) {
    const modal = document.getElementById('rejectModal');
    if (event.target == modal) {
        closeRejectModal();
    }
}
</script>
{% endblock %}

