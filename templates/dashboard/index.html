{% extends "base.html" %}

{% block title %}Dashboard - ZedinArkManager{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="page-header">
        <h2><i class="fas fa-home"></i> Dashboard</h2>
        <p>√údv√∂z√∂lj√ºk, {{ user.username }}!</p>
    </div>
    
    <div class="dashboard-layout">
        <div class="dashboard-main">
            <div class="stats-grid">
        {% if user.role.value == "manager_admin" %}
            <div class="stat-card">
                <div class="stat-icon" style="background: #667eea;">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.total_users or 0 }}</h3>
                    <p>√ñsszes felhaszn√°l√≥</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: #764ba2;">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.server_admins or 0 }}</h3>
                    <p>Szerver Admin</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: #f093fb;">
                    <i class="fas fa-user-cog"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.admins or 0 }}</h3>
                    <p>Admin</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: #4facfe;">
                    <i class="fas fa-key"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.active_tokens or 0 }}</h3>
                    <p>Akt√≠v tokenek</p>
                </div>
            </div>
        {% elif user.role.value == "server_admin" %}
            <div class="stat-card">
                <div class="stat-icon" style="background: #667eea;">
                    <i class="fas fa-server"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.my_servers or 0 }}</h3>
                    <p>Szervereim</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: #764ba2;">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.my_admins or 0 }}</h3>
                    <p>Admin felhaszn√°l√≥im</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: #4facfe;">
                    <i class="fas fa-key"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ stats.my_tokens or 0 }}</h3>
                    <p>Akt√≠v tokenjeim</p>
                </div>
            </div>
            
            <div class="stat-card" style="cursor: pointer;" onclick="showTokenRequestModal()">
                <div class="stat-icon" style="background: #f093fb;">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stat-content">
                    <h3 id="cartCount">{{ stats.cart_count or 0 }}</h3>
                    <p>Kos√°r</p>
                </div>
            </div>
        {% endif %}
    </div>
    
    {% if user.role.value == "server_admin" %}
        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3><i class="fas fa-key"></i> Tokenjeim</h3>
                <button class="btn btn-primary" onclick="showTokenRequestModal()">
                    <i class="fas fa-plus"></i> Token ig√©nyl√©s
                </button>
            </div>
        {% if tokens %}
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>T√≠pus</th>
                            <th>Lej√°rat</th>
                            <th>St√°tusz</th>
                            <th>M≈±veletek</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for token in tokens %}
                            <tr>
                                <td><code>{{ token.token[:20] }}...</code></td>
                                <td>{{ "Szerver Admin" if token.token_type.value == "server_admin" else "Felhaszn√°l√≥" }}</td>
                                <td>{{ token.expires_at.strftime("%Y-%m-%d %H:%M") if token.expires_at else "-" }}</td>
                                <td>
                                    {% if token.is_active %}
                                        <span class="badge badge-success">Akt√≠v</span>
                                    {% else %}
                                        <span class="badge badge-warning">Inakt√≠v</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if token.is_active %}
                                        <button class="btn btn-primary btn-sm add-to-cart-btn" 
                                                data-token-id="{{ token.id }}" 
                                                data-expires-at="{{ token.expires_at.strftime('%Y-%m-%d %H:%M') if token.expires_at else '' }}"
                                                onclick="showExtensionRequestModal({{ token.id }}, '{{ token.expires_at.strftime('%Y-%m-%d %H:%M') if token.expires_at else '' }}')">
                                            <i class="fas fa-shopping-cart"></i> Kos√°rba
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="card-body">
                <p>Nincsenek tokenjeid. <a href="javascript:void(0)" onclick="showTokenRequestModal()">Ig√©nyelj tokent!</a></p>
            </div>
        {% endif %}
        </div>
        
        {% if stats.cart_count and stats.cart_count > 0 %}
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-shopping-cart"></i> Kosaram</h3>
                </div>
                <div class="card-body">
                    <p>A kosaradban <strong>{{ stats.cart_count }}</strong> elem van.</p>
                    <a href="/cart" class="btn btn-primary">
                        <i class="fas fa-shopping-cart"></i> Kos√°r megtekint√©se
                    </a>
                </div>
            </div>
        {% endif %}
    {% endif %}
    
            <!-- Szerver Kihaszn√°lts√°g -->
            <div class="system-monitoring">
                <div class="page-header">
                    <h2><i class="fas fa-server"></i> Szerver Kihaszn√°lts√°g</h2>
                    <p>Val√≥s idej≈± rendszer inform√°ci√≥k</p>
                </div>
                
                <div class="monitoring-grid">
                    <!-- CPU -->
                    <div class="monitoring-card">
                        <div class="monitoring-header">
                            <h3><i class="fas fa-microchip"></i> CPU</h3>
                            <span class="monitoring-value" id="cpuPercent">0%</span>
                        </div>
                        <div class="monitoring-chart">
                            <canvas id="cpuChart"></canvas>
                        </div>
                        <div class="monitoring-info">
                            <span id="cpuInfo">Magok: 0</span>
                        </div>
                    </div>
                    
                    <!-- RAM -->
                    <div class="monitoring-card">
                        <div class="monitoring-header">
                            <h3><i class="fas fa-memory"></i> RAM</h3>
                            <span class="monitoring-value" id="ramPercent">0%</span>
                        </div>
                        <div class="monitoring-chart">
                            <canvas id="ramChart"></canvas>
                        </div>
                        <div class="monitoring-info">
                            <span id="ramInfo">0 GB / 0 GB</span>
                        </div>
                    </div>
                    
                    <!-- HDD -->
                    <div class="monitoring-card">
                        <div class="monitoring-header">
                            <h3><i class="fas fa-hdd"></i> HDD</h3>
                            <span class="monitoring-value" id="hddPercent">0%</span>
                        </div>
                        <div class="monitoring-chart">
                            <canvas id="hddChart"></canvas>
                        </div>
                        <div class="monitoring-info">
                            <span id="hddInfo">0 GB / 0 GB</span>
                        </div>
                    </div>
                    
                    <!-- PING -->
                    <div class="monitoring-card">
                        <div class="monitoring-header">
                            <h3><i class="fas fa-network-wired"></i> PING</h3>
                            <span class="monitoring-value" id="pingMs">0 ms</span>
                        </div>
                        <div class="monitoring-chart">
                            <canvas id="pingChart"></canvas>
                        </div>
                        <div class="monitoring-info">
                            <span id="pingInfo">H√°l√≥zati k√©sleltet√©s</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Chat Widget -->
        <div class="dashboard-sidebar">
            <div class="ai-chat-widget">
                <div class="ai-chat-header">
                    <h3><i class="fas fa-robot"></i> AI Asszisztens</h3>
                    <span class="ai-status online">Online</span>
                </div>
                <div class="ai-chat-messages" id="aiChatMessages">
                    <div class="ai-message bot">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <p>√údv√∂z√∂llek! üòä Miben seg√≠thetek neked a ZedinArkManager rendszerben?</p>
                        </div>
                    </div>
                </div>
                <div class="ai-chat-input">
                    <input type="text" id="aiChatInput" placeholder="√çrj ide egy √ºzenetet..." autocomplete="off">
                    <button id="aiChatSend" onclick="sendAIMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Chart konfigur√°ci√≥k
const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            display: false
        },
        tooltip: {
            enabled: false
        }
    },
    scales: {
        y: {
            beginAtZero: true,
            max: 100,
            display: false
        },
        x: {
            display: false
        }
    },
    elements: {
        point: {
            radius: 0
        }
    }
};

// CPU Chart
const cpuCtx = document.getElementById('cpuChart').getContext('2d');
const cpuChart = new Chart(cpuCtx, {
    type: 'line',
    data: {
        labels: Array(20).fill(''),
        datasets: [{
            label: 'CPU %',
            data: Array(20).fill(0),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: chartOptions
});

// RAM Chart
const ramCtx = document.getElementById('ramChart').getContext('2d');
const ramChart = new Chart(ramCtx, {
    type: 'line',
    data: {
        labels: Array(20).fill(''),
        datasets: [{
            label: 'RAM %',
            data: Array(20).fill(0),
            borderColor: '#764ba2',
            backgroundColor: 'rgba(118, 75, 162, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: chartOptions
});

// HDD Chart
const hddCtx = document.getElementById('hddChart').getContext('2d');
const hddChart = new Chart(hddCtx, {
    type: 'line',
    data: {
        labels: Array(20).fill(''),
        datasets: [{
            label: 'HDD %',
            data: Array(20).fill(0),
            borderColor: '#f093fb',
            backgroundColor: 'rgba(240, 147, 251, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: chartOptions
});

// PING Chart
const pingCtx = document.getElementById('pingChart').getContext('2d');
const pingChart = new Chart(pingCtx, {
    type: 'line',
    data: {
        labels: Array(20).fill(''),
        datasets: [{
            label: 'PING ms',
            data: Array(20).fill(0),
            borderColor: '#4facfe',
            backgroundColor: 'rgba(79, 172, 254, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        ...chartOptions,
        scales: {
            ...chartOptions.scales,
            y: {
                beginAtZero: true,
                max: 100,
                display: false
            }
        }
    }
});

// Adatok friss√≠t√©se
function updateSystemStats() {
    fetch('/api/system/stats')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('System stats error:', data.error);
                return;
            }
            
            // CPU
            const cpuPercent = Math.round(data.cpu.percent);
            document.getElementById('cpuPercent').textContent = cpuPercent + '%';
            document.getElementById('cpuInfo').textContent = `Magok: ${data.cpu.count} (${data.cpu.cores} fizikai)`;
            updateChart(cpuChart, cpuPercent);
            
            // RAM
            const ramPercent = Math.round(data.ram.percent);
            document.getElementById('ramPercent').textContent = ramPercent + '%';
            document.getElementById('ramInfo').textContent = `${data.ram.used_gb} GB / ${data.ram.total_gb} GB`;
            updateChart(ramChart, ramPercent);
            
            // HDD
            const hddPercent = Math.round(data.hdd.percent);
            document.getElementById('hddPercent').textContent = hddPercent + '%';
            document.getElementById('hddInfo').textContent = `${data.hdd.used_gb} GB / ${data.hdd.total_gb} GB`;
            updateChart(hddChart, hddPercent);
            
            // PING
            const pingMs = data.ping.ms !== null ? Math.round(data.ping.ms) : 0;
            document.getElementById('pingMs').textContent = pingMs + ' ms';
            document.getElementById('pingInfo').textContent = pingMs < 10 ? 'Kiv√°l√≥' : pingMs < 50 ? 'J√≥' : 'K√∂zepes';
            updateChart(pingChart, pingMs);
        })
        .catch(error => {
            console.error('System stats fetch error:', error);
        });
}

// Chart friss√≠t√©se
function updateChart(chart, newValue) {
    chart.data.datasets[0].data.shift();
    chart.data.datasets[0].data.push(newValue);
    chart.update('none');
}

// 2 m√°sodpercenk√©nt friss√≠t√©s
setInterval(updateSystemStats, 2000);
updateSystemStats(); // Azonnali friss√≠t√©s

// AI Chat funkci√≥k
const aiChatInput = document.getElementById('aiChatInput');
const aiChatMessages = document.getElementById('aiChatMessages');
const aiChatSend = document.getElementById('aiChatSend');

// Enter gomb kezel√©se
if (aiChatInput) {
    aiChatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendAIMessage();
        }
    });
}

// Send gomb kezel√©se
if (aiChatSend) {
    aiChatSend.addEventListener('click', sendAIMessage);
}

function sendAIMessage() {
    if (!aiChatInput || !aiChatMessages) return;
    
    const message = aiChatInput.value.trim();
    if (!message) return;
    
    // Felhaszn√°l√≥ √ºzenet hozz√°ad√°sa
    addMessage(message, 'user');
    aiChatInput.value = '';
    
    // Loading state
    const loadingMessage = addMessage('K√ºld√©s...', 'bot');
    loadingMessage.classList.add('loading');
    
    // AI v√°lasz k√©r√©se
    fetch('/api/ai/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        // Loading message elt√°vol√≠t√°sa
        const loadingMsg = aiChatMessages.querySelector('.loading');
        if (loadingMsg) {
            loadingMsg.remove();
        }
        
        if (data.success) {
            addMessage(data.response, 'bot');
        } else {
            addMessage('Sajn√°lom, hiba t√∂rt√©nt. Pr√≥b√°ld √∫jra k√©s≈ëbb!', 'bot');
        }
    })
    .catch(error => {
        console.error('AI Chat error:', error);
        // Loading message elt√°vol√≠t√°sa
        const loadingMsg = aiChatMessages.querySelector('.loading');
        if (loadingMsg) {
            loadingMsg.remove();
        }
        addMessage('Sajn√°lom, hiba t√∂rt√©nt. Pr√≥b√°ld √∫jra k√©s≈ëbb!', 'bot');
    });
}

function addMessage(text, type) {
    if (!aiChatMessages) return null;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `ai-message ${type}`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.innerHTML = type === 'bot' ? '<i class="fas fa-robot"></i>' : '<i class="fas fa-user"></i>';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    const p = document.createElement('p');
    p.textContent = text;
    content.appendChild(p);
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    aiChatMessages.appendChild(messageDiv);
    aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
    
    return messageDiv;
}

// Token Hosszabb√≠t√°si K√©r√©s Modal
function showExtensionRequestModal(tokenId, currentExpiry) {
    try {
        const tokenIdInput = document.getElementById('extensionRequestTokenId');
        const currentExpirySpan = document.getElementById('currentExpiryRequest');
        const modal = document.getElementById('extensionRequestModal');
        
        if (!tokenIdInput || !currentExpirySpan || !modal) {
            console.error('Modal elements not found');
            alert('Hiba: A modal elemek nem tal√°lhat√≥k. K√©rlek friss√≠tsd az oldalt.');
            return;
        }
        
        tokenIdInput.value = tokenId;
        currentExpirySpan.textContent = currentExpiry || 'Nincs lej√°rat';
        
        // √öj lej√°rat sz√°m√≠t√°sa
        const daysInput = document.getElementById('extensionRequestDays');
        if (daysInput) {
            daysInput.value = 30; // Reset to default
            daysInput.removeEventListener('input', updateNewExpiryRequest);
            daysInput.addEventListener('input', updateNewExpiryRequest);
            updateNewExpiryRequest();
        }
        
        // Modal megjelen√≠t√©se
        modal.style.display = 'block';
    } catch (error) {
        console.error('Error showing extension request modal:', error);
        alert('Hiba t√∂rt√©nt a modal megnyit√°sakor. K√©rlek pr√≥b√°ld √∫jra.');
    }
}

function closeExtensionRequestModal() {
    const modal = document.getElementById('extensionRequestModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Token Ig√©nyl√©s Modal (√°tir√°ny√≠t√°s a token gener√°l√°s oldalra)
function showTokenRequestModal() {
    window.location.href = '/tokens/generate';
}

function updateNewExpiryRequest() {
    const daysInput = document.getElementById('extensionRequestDays');
    if (!daysInput) return;
    
    const days = parseInt(daysInput.value) || 0;
    const currentExpiryText = document.getElementById('currentExpiryRequest').textContent;
    
    if (currentExpiryText && currentExpiryText !== 'Nincs lej√°rat') {
        // Parse magyar d√°tum form√°tum: YYYY-MM-DD HH:MM
        const parts = currentExpiryText.split(' ');
        const dateParts = parts[0].split('-');
        const timeParts = parts[1] ? parts[1].split(':') : [0, 0];
        
        const currentDate = new Date(
            parseInt(dateParts[0]),
            parseInt(dateParts[1]) - 1,
            parseInt(dateParts[2]),
            parseInt(timeParts[0]),
            parseInt(timeParts[1])
        );
        
        const newDate = new Date(currentDate);
        newDate.setDate(newDate.getDate() + days);
        
        const formattedDate = newDate.toLocaleDateString('hu-HU') + ' ' + 
                             newDate.toLocaleTimeString('hu-HU', {hour: '2-digit', minute: '2-digit'});
        document.getElementById('newExpiryRequest').textContent = formattedDate;
    } else {
        const today = new Date();
        const newDate = new Date(today);
        newDate.setDate(newDate.getDate() + days);
        
        const formattedDate = newDate.toLocaleDateString('hu-HU') + ' ' + 
                             newDate.toLocaleTimeString('hu-HU', {hour: '2-digit', minute: '2-digit'});
        document.getElementById('newExpiryRequest').textContent = formattedDate;
    }
}

// Extension Request Modal bez√°r√°sa kattint√°sra a h√°tt√©rre
const originalOnClick = window.onclick;
window.onclick = function(event) {
    if (originalOnClick) originalOnClick(event);
    
    const extensionModal = document.getElementById('extensionRequestModal');
    if (event.target == extensionModal) {
        closeExtensionRequestModal();
    }
}
</script>

<!-- Token Hosszabb√≠t√°si K√©r√©s Modal -->
<div id="extensionRequestModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 10px; width: 500px; max-width: 90%;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3><i class="fas fa-clock"></i> Token Hosszabb√≠t√°si K√©r√©s</h3>
            <button onclick="closeExtensionRequestModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <form method="POST" action="/cart/add-extension-request" id="extensionRequestForm">
            <input type="hidden" name="token_id" id="extensionRequestTokenId">
            <div style="margin-bottom: 15px;">
                <label for="extensionRequestDays" style="display: block; margin-bottom: 5px; font-weight: bold;">H√°ny napra szeretn√©d meghosszabb√≠tani?</label>
                <input type="number" class="form-control" id="extensionRequestDays" name="requested_days" min="1" max="365" value="30" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <small style="color: #666;">1-365 nap k√∂z√∂tt lehet megadni</small>
            </div>
            <div style="margin-bottom: 15px;">
                <label for="extensionRequestNotes" style="display: block; margin-bottom: 5px; font-weight: bold;">Megjegyz√©s (opcion√°lis):</label>
                <textarea id="extensionRequestNotes" name="notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
            </div>
            <div class="alert alert-info" style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <strong>Jelenlegi lej√°rat:</strong> <span id="currentExpiryRequest"></span><br>
                <strong>K√©rt √∫j lej√°rat:</strong> <span id="newExpiryRequest" style="color: #667eea; font-weight: bold;"></span>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeExtensionRequestModal()" class="btn btn-secondary" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">M√©gse</button>
                <button type="submit" class="btn btn-primary" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-shopping-cart"></i> Kos√°rba teszem
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

