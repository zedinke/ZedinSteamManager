{% extends "base.html" %}

{% block title %}Ark Szerverek - ZedinArkManager{% endblock %}

{% block content %}
<div class="page">
    <div class="page-header">
        <h2><i class="fas fa-server"></i> Ark Szerverek</h2>
        <p>Ark Survival Ascended szerverek kezelése</p>
    </div>
    
    {% if request.query_params.get("success") %}
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> {{ request.query_params.get("success") }}
        </div>
    {% endif %}
    
    {% if request.query_params.get("error") %}
        <div class="alert alert-error">
            <i class="fas fa-exclamation-circle"></i> {{ request.query_params.get("error") }}
        </div>
    {% endif %}
    
    <div style="margin-bottom: 20px;">
        <a href="/ark/servers/create" class="btn btn-primary">
            <i class="fas fa-plus"></i> Új Szerver Létrehozása
        </a>
        <a href="/ark/clusters" class="btn btn-secondary" style="margin-left: 10px;">
            <i class="fas fa-network-wired"></i> Cluster-ek
        </a>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-list"></i> Szerverek</h3>
        </div>
        <div class="card-body">
            {% if servers_data %}
                <table class="table">
                    <thead>
                        <tr>
                            <th>Név</th>
                            <th>Cluster</th>
                            <th>Port</th>
                            <th>Query Port</th>
                            <th>RCON Port</th>
                            <th>Max Játékosok</th>
                            <th>RAM Limit</th>
                            <th>Vásárolt RAM</th>
                            <th>Státusz</th>
                            <th>Token információk</th>
                            <th>Létrehozva</th>
                            <th>Műveletek</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in servers_data %}
                        {% set server = item.server %}
                            <tr>
                                <td><strong>{{ server.name }}</strong></td>
                                <td>
                                    {% if server.cluster %}
                                        <code>{{ server.cluster.cluster_id }}</code>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ server.port or '-' }}</td>
                                <td>{{ server.query_port or '-' }}</td>
                                <td>{{ server.rcon_port or '-' }}</td>
                                <td>{{ server.max_players }}</td>
                                <td>
                                    {% if server.ram_limit_gb %}
                                        {{ server.ram_limit_gb }} GB
                                        {% if is_manager_admin %}
                                            <br><button type="button" class="btn btn-xs btn-secondary" onclick="showRamLimitModal({{ server.id }}, {{ server.ram_limit_gb }})" title="RAM limit módosítása">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">Nincs beállítva</span>
                                        {% if is_manager_admin %}
                                            <br><button type="button" class="btn btn-xs btn-primary" onclick="showRamLimitModal({{ server.id }}, 0)" title="RAM limit beállítása">
                                                <i class="fas fa-plus"></i> Beállítás
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if server.purchased_ram_gb and server.purchased_ram_gb > 0 %}
                                        {{ server.purchased_ram_gb }} GB
                                        {% if not is_manager_admin %}
                                            <br><button type="button" class="btn btn-xs btn-success" onclick="showRamPurchaseModal({{ server.id }}, {{ server.purchased_ram_gb }})" title="RAM bővítés vásárlása">
                                                <i class="fas fa-shopping-cart"></i> Bővítés
                                            </button>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">0 GB</span>
                                        {% if not is_manager_admin %}
                                            <br><button type="button" class="btn btn-xs btn-success" onclick="showRamPurchaseModal({{ server.id }}, 0)" title="RAM bővítés vásárlása">
                                                <i class="fas fa-shopping-cart"></i> Vásárlás
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if server.status.value == 'running' %}
                                        <span class="badge badge-success">Fut</span>
                                    {% elif server.status.value == 'stopped' %}
                                        <span class="badge badge-secondary">Leállítva</span>
                                    {% elif server.status.value == 'restarting' %}
                                        <span class="badge badge-warning">Újraindítás</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if server.token_used_id %}
                                        {% if item.token_expired %}
                                            <div class="text-danger">
                                                <i class="fas fa-exclamation-triangle"></i> Token lejárt
                                            </div>
                                        {% else %}
                                            {% if item.token_days_left is not none %}
                                                <div class="text-info">
                                                    <i class="fas fa-key"></i> {{ item.token_days_left }} nap
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">Nincs token</span>
                                    {% endif %}
                                </td>
                                <td>{{ server.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                        {% if server.status.value == 'running' %}
                                            <form method="POST" action="/ark/servers/{{ server.id }}/stop" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-warning" title="Szerver leállítása">
                                                    <i class="fas fa-stop"></i> Leállítás
                                                </button>
                                            </form>
                                            <form method="POST" action="/ark/servers/{{ server.id }}/restart" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-info" title="Szerver újraindítása">
                                                    <i class="fas fa-redo"></i> Újraindítás
                                                </button>
                                            </form>
                                        {% else %}
                                            <form method="POST" action="/ark/servers/{{ server.id }}/start" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-success" title="Szerver indítása">
                                                    <i class="fas fa-play"></i> Indítás
                                                </button>
                                            </form>
                                        {% endif %}
                                        <a href="/ark/servers/{{ server.id }}/edit" class="btn btn-sm btn-primary" title="Szerver szerkesztése">
                                            <i class="fas fa-edit"></i> Szerkesztés
                                        </a>
                                        <button type="button" class="btn btn-sm btn-info" onclick="showServerLogs({{ server.id }})" title="Indítási logok megtekintése">
                                            <i class="fas fa-file-alt"></i> Logok
                                        </button>
                                        <form method="POST" action="/ark/servers/{{ server.id }}/delete" 
                                              style="display: inline;"
                                              onsubmit="return confirm('Biztosan törlöd ezt a szervert? Ez a művelet nem visszavonható!');">
                                            <button type="submit" class="btn btn-sm btn-danger" title="Szerver törlése">
                                                <i class="fas fa-trash"></i> Törlés
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% if item.start_command %}
                            <tr class="command-row" style="background-color: #f8f9fa;">
                                <td colspan="12" style="padding: 10px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <strong style="min-width: 120px;">Indítási parancs:</strong>
                                        <code style="flex: 1; background: #1e1e1e; color: #d4d4d4; padding: 8px 12px; border-radius: 4px; font-size: 12px; word-break: break-all; white-space: pre-wrap;">{{ item.start_command }}</code>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="copyCommand(this)" title="Parancs másolása">
                                            <i class="fas fa-copy"></i> Másolás
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Még nincs létrehozott Ark szerver. 
                    <a href="/ark/servers/create">Hozz létre egyet most!</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copyCommand(button) {
    const codeElement = button.closest('td').querySelector('code');
    const text = codeElement.textContent;
    
    // Clipboard API használata
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> Másolva!';
            button.classList.add('btn-success');
            button.classList.remove('btn-secondary');
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                button.classList.add('btn-secondary');
            }, 2000);
        }).catch(err => {
            console.error('Hiba a másolás során:', err);
            alert('Nem sikerült a másolás');
        });
    } else {
        // Fallback: régi módszer
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> Másolva!';
            button.classList.add('btn-success');
            button.classList.remove('btn-secondary');
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                button.classList.add('btn-secondary');
            }, 2000);
        } catch (err) {
            alert('Nem sikerült a másolás');
        }
        document.body.removeChild(textarea);
    }
}

{% if is_manager_admin %}
// RAM Limit Modal (Manager Admin)
function showRamLimitModal(serverId, currentLimit) {
    const limit = prompt('Adja meg a RAM limitet GB-ban:', currentLimit || '');
    if (limit !== null && limit !== '') {
        const limitValue = parseInt(limit);
        if (isNaN(limitValue) || limitValue < 0) {
            alert('Érvénytelen érték! Kérjük, adjon meg egy pozitív számot.');
            return;
        }
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/ark/servers/${serverId}/ram-limit`;
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'ram_limit_gb';
        input.value = limitValue;
        form.appendChild(input);
        
        document.body.appendChild(form);
        form.submit();
    }
}
{% endif %}

{% if not is_manager_admin and ram_pricing %}
// RAM Purchase Modal (Server Admin)
function showRamPurchaseModal(serverId, currentPurchased) {
    const ramGb = prompt('Hány GB RAM-ot szeretne vásárolni?', '');
    if (ramGb !== null && ramGb !== '') {
        const ramValue = parseInt(ramGb);
        if (isNaN(ramValue) || ramValue <= 0) {
            alert('Érvénytelen érték! Kérjük, adjon meg egy pozitív számot.');
            return;
        }
        
        const pricePerGb = {{ ram_pricing.price_per_gb_eur / 100 }};
        const totalPrice = ramValue * pricePerGb;
        
        if (confirm(`RAM bővítés vásárlása:\n\nMennyiség: ${ramValue} GB\nÁr: ${totalPrice.toFixed(2)} EUR\n\nFolytatja?`)) {
            // Hozzáadás a kosárhoz
            window.location.href = `/cart/add-ram-upgrade?server_id=${serverId}&ram_gb=${ramValue}`;
        }
    }
}
{% endif %}

<!-- Logok Modal -->
<div id="logsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90vh; overflow: auto; position: relative;">
        <button onclick="closeLogsModal()" style="position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">
            <i class="fas fa-times"></i> Bezárás
        </button>
        <h3 style="margin-top: 0;"><i class="fas fa-file-alt"></i> Szerver Indítási Logok</h3>
        <div id="logsContent" style="margin-top: 20px;">
            <p>Logok betöltése...</p>
        </div>
        <div style="margin-top: 10px; display: flex; gap: 10px;">
            <button onclick="refreshLogs()" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i> Frissítés
            </button>
            <button onclick="closeLogsModal()" class="btn btn-secondary">
                Bezárás
            </button>
        </div>
    </div>
</div>

<script>
let currentServerId = null;
let logsModal = document.getElementById('logsModal');
let logsContent = document.getElementById('logsContent');

function closeLogsModal() {
    logsModal.style.display = 'none';
    currentServerId = null;
}

function refreshLogs() {
    if (currentServerId) {
        showServerLogs(currentServerId);
    }
}

async function showServerLogs(serverId) {
    currentServerId = serverId;
    logsModal.style.display = 'flex';
    logsContent.innerHTML = '<p>Logok betöltése...</p>';
    
    try {
        const response = await fetch(`/ark/servers/${serverId}/logs`);
        const data = await response.json();
        
        if (data.success) {
            let html = `<div style="margin-bottom: 10px;">`;
            html += `<strong>Log fájl:</strong> ${data.log_file}<br>`;
            html += `<strong>Méret:</strong> ${(data.file_size / 1024).toFixed(2)} KB`;
            html += `</div>`;
            html += `<textarea readonly style="width: 100%; height: 500px; font-family: monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; white-space: pre-wrap; background: #1e1e1e; color: #d4d4d4;">${escapeHtml(data.log_content)}</textarea>`;
            html += `<div style="margin-top: 10px;">`;
            html += `<button onclick="copyLogs()" class="btn btn-primary"><i class="fas fa-copy"></i> Másolás</button>`;
            html += `</div>`;
            logsContent.innerHTML = html;
        } else {
            logsContent.innerHTML = `<div class="alert alert-error">${data.message || 'Logok betöltése sikertelen'}</div>`;
        }
    } catch (error) {
        logsContent.innerHTML = `<div class="alert alert-error">Hiba a logok betöltése során: ${error.message}</div>`;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function copyLogs() {
    const textarea = logsContent.querySelector('textarea');
    if (textarea) {
        textarea.select();
        document.execCommand('copy');
        alert('Logok másolva a vágólapra!');
    }
}

// Modal bezárása kattintásra a háttérre
logsModal.addEventListener('click', function(e) {
    if (e.target === logsModal) {
        closeLogsModal();
    }
});
</script>
{% endblock %}

