{% extends "base.html" %}

{% block title %}Ark Szerverek - ZedinArkManager{% endblock %}

{% block content %}
<div class="page">
    <div class="page-header">
        <h2><i class="fas fa-server"></i> Ark Szerverek</h2>
        <p>Ark Survival Ascended szerverek kezelése</p>
    </div>
    
    {% if request.query_params.get("success") %}
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> {{ request.query_params.get("success") }}
        </div>
    {% endif %}
    
    {% if request.query_params.get("error") %}
        <div class="alert alert-error">
            <i class="fas fa-exclamation-circle"></i> {{ request.query_params.get("error") }}
        </div>
    {% endif %}
    
    <div style="margin-bottom: 20px;">
        <a href="/ark/servers/create" class="btn btn-primary">
            <i class="fas fa-plus"></i> Új Szerver Létrehozása
        </a>
        <a href="/ark/clusters" class="btn btn-secondary" style="margin-left: 10px;">
            <i class="fas fa-network-wired"></i> Cluster-ek
        </a>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-list"></i> Szerverek</h3>
        </div>
        <div class="card-body">
            {% if servers_data %}
                <table class="table">
                    <thead>
                        <tr>
                            <th>Név</th>
                            <th>Cluster</th>
                            <th>Port</th>
                            <th>Query Port</th>
                            <th>RCON Port</th>
                            <th>Max Játékosok</th>
                            <th>Státusz</th>
                            <th>Token információk</th>
                            <th>Létrehozva</th>
                            <th>Műveletek</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in servers_data %}
                        {% set server = item.server %}
                            <tr>
                                <td><strong>{{ server.name }}</strong></td>
                                <td>
                                    {% if server.cluster %}
                                        <code>{{ server.cluster.cluster_id }}</code>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ server.port or '-' }}</td>
                                <td>{{ server.query_port or '-' }}</td>
                                <td>{{ server.rcon_port or '-' }}</td>
                                <td>{{ server.max_players }}</td>
                                <td>
                                    {% if server.status.value == 'running' %}
                                        <span class="badge badge-success">Fut</span>
                                    {% elif server.status.value == 'stopped' %}
                                        <span class="badge badge-secondary">Leállítva</span>
                                    {% elif server.status.value == 'restarting' %}
                                        <span class="badge badge-warning">Újraindítás</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if server.token_used_id %}
                                        {% if item.token_expired %}
                                            <div class="text-danger">
                                                <i class="fas fa-exclamation-triangle"></i> Token lejárt
                                            </div>
                                        {% else %}
                                            {% if item.token_days_left is not none %}
                                                <div class="text-info">
                                                    <i class="fas fa-key"></i> {{ item.token_days_left }} nap
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">Nincs token</span>
                                    {% endif %}
                                </td>
                                <td>{{ server.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                        {% if server.status.value == 'running' %}
                                            <form method="POST" action="/ark/servers/{{ server.id }}/stop" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-warning" title="Szerver leállítása">
                                                    <i class="fas fa-stop"></i> Leállítás
                                                </button>
                                            </form>
                                            <form method="POST" action="/ark/servers/{{ server.id }}/restart" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-info" title="Szerver újraindítása">
                                                    <i class="fas fa-redo"></i> Újraindítás
                                                </button>
                                            </form>
                                        {% else %}
                                            <form method="POST" action="/ark/servers/{{ server.id }}/start" style="display: inline;">
                                                <button type="submit" class="btn btn-sm btn-success" title="Szerver indítása">
                                                    <i class="fas fa-play"></i> Indítás
                                                </button>
                                            </form>
                                        {% endif %}
                                        <a href="/ark/servers/{{ server.id }}/edit" class="btn btn-sm btn-primary" title="Szerver szerkesztése">
                                            <i class="fas fa-edit"></i> Szerkesztés
                                        </a>
                                        <form method="POST" action="/ark/servers/{{ server.id }}/delete" 
                                              style="display: inline;"
                                              onsubmit="return confirm('Biztosan törlöd ezt a szervert? Ez a művelet nem visszavonható!');">
                                            <button type="submit" class="btn btn-sm btn-danger" title="Szerver törlése">
                                                <i class="fas fa-trash"></i> Törlés
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% if item.start_command %}
                            <tr class="command-row" style="background-color: #f8f9fa;">
                                <td colspan="10" style="padding: 10px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <strong style="min-width: 120px;">Indítási parancs:</strong>
                                        <code style="flex: 1; background: #1e1e1e; color: #d4d4d4; padding: 8px 12px; border-radius: 4px; font-size: 12px; word-break: break-all; white-space: pre-wrap;">{{ item.start_command }}</code>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="copyCommand(this)" title="Parancs másolása">
                                            <i class="fas fa-copy"></i> Másolás
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Még nincs létrehozott Ark szerver. 
                    <a href="/ark/servers/create">Hozz létre egyet most!</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copyCommand(button) {
    const codeElement = button.closest('td').querySelector('code');
    const text = codeElement.textContent;
    
    // Clipboard API használata
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> Másolva!';
            button.classList.add('btn-success');
            button.classList.remove('btn-secondary');
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                button.classList.add('btn-secondary');
            }, 2000);
        }).catch(err => {
            console.error('Hiba a másolás során:', err);
            alert('Nem sikerült a másolás');
        });
    } else {
        // Fallback: régi módszer
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> Másolva!';
            button.classList.add('btn-success');
            button.classList.remove('btn-secondary');
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                button.classList.add('btn-secondary');
            }, 2000);
        } catch (err) {
            alert('Nem sikerült a másolás');
        }
        document.body.removeChild(textarea);
    }
}
</script>
{% endblock %}

