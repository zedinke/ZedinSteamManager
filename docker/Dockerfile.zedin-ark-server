# ZedinArkManager - ARK Survival Ascended Server Docker Image
# Saját struktúrát használ: /home/ai_developer/arkserver

FROM debian:12

# Környezeti változók
ENV DEBIAN_FRONTEND=noninteractive
ENV ARK_SERVER_DIR=/home/ai_developer/arkserver
ENV STEAMCMD_DIR=/home/ai_developer/steamcmd

# Felhasználó létrehozása (ai_developer user)
# UID 1000 használata - ez csak a konténeren belül van, nem ütközik a host felhasználókkal
# FONTOS: NE hozzuk létre a mappákat itt! A manager már létrehozza megfelelő jogosultságokkal.
# Csak a felhasználót hozzuk létre, a mappákat a host oldalon a manager hozza létre.
RUN useradd -m -u 1000 -s /bin/bash ai_developer && \
    chown -R ai_developer:ai_developer /home/ai_developer

# Wine repository hozzáadása (Debian 12)
RUN dpkg --add-architecture i386 && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        gnupg2 \
        ca-certificates \
        wget \
        && \
    mkdir -pm755 /etc/apt/keyrings && \
    wget -O /etc/apt/keyrings/winehq-archive.key https://dl.winehq.org/wine-builds/winehq.key && \
    echo "Types: deb\nURIs: https://dl.winehq.org/wine-builds/debian/\nSuites: bookworm\nComponents: main\nSigned-By: /etc/apt/keyrings/winehq-archive.key" > /etc/apt/sources.list.d/winehq-bookworm.sources && \
    apt-get update

# Szükséges csomagok telepítése
RUN apt-get install -y --no-install-recommends \
        curl \
        lib32gcc-s1 \
        lib32stdc++6 \
        libc6-i386 \
        wget \
        unzip \
        ca-certificates \
        winehq-stable \
        xvfb \
        && \
    rm -rf /var/lib/apt/lists/*

# Winetricks telepítése (külön, mert nincs a Debian repository-kban)
RUN wget -O /usr/local/bin/winetricks https://raw.githubusercontent.com/Winetricks/winetricks/master/src/winetricks && \
    chmod +x /usr/local/bin/winetricks

# SteamCMD letöltése és telepítése
# FONTOS: NE hozzuk létre a mappát! A manager már létrehozza megfelelő jogosultságokkal a host-on.
# A SteamCMD mappa volume mount-tal lesz elérhető a konténeren belül.
# Ha a mappa nem létezik, a SteamCMD telepítés sikertelen lesz, de ez rendben van,
# mert a manager felelős a mappák létrehozásáért.
RUN cd ${STEAMCMD_DIR} && \
    curl -sqL "https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz" | tar zxvf - && \
    chown -R ai_developer:ai_developer ${STEAMCMD_DIR} && \
    chmod +x ${STEAMCMD_DIR}/steamcmd.sh && \
    # Ellenőrizzük, hogy a SteamCMD telepítve van-e
    test -f ${STEAMCMD_DIR}/steamcmd.sh || (echo "HIBA: SteamCMD telepítése sikertelen!" && exit 1)

# Entrypoint script másolása (root-ként, mert még nem váltottunk felhasználót)
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh && \
    chown root:root /usr/local/bin/entrypoint.sh

# Munkakönyvtár beállítása
WORKDIR ${ARK_SERVER_DIR}

# Felhasználó váltás
USER ai_developer

# Entrypoint beállítása
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]

